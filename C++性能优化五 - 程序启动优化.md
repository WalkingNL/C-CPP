## 程序的启动优化

### 前言


### 背景介绍

编译、链接、加载

链接包含两个重要的任务：符号解析及重定位

链接 发生的时机：代码静态编译、程序被加载、应用程序执行的时候


编译器：翻译源文件，产生二进制的目标代码文件

链接器与加载器的功能在某些方面有重合，主要功能有以下：
1. 程序装载：拷贝程序到内存中，以准备运行。某些情况下，仅仅是这个拷贝的工作。但某些情况下，还包含分配存储空间、设置内存保护位、映射虚拟地址到磁盘页面。

2. 重定位：为输出的目标文件中的每一部分指定一个加载地址，并修改相应的代码和数据以反映这样的变化。

3. 符号解析：由多个子程序构建一个可执行程序，子程序之间的相互引用通过符号进行。程序也可以通过符号来引用代码库中的功能。符号解析就是将**符号引用**与**符号定义**关联起来。


(1) 定义启动性能问题，包括定义启动阶段的范围和设定启动性能的可行目标；
(2) 在定义启动性能的问题之后，测试取得具体的启动性能数据；
(3) 在(1)(2)的基础上，利用性能工具确定应用程序启动的性能瓶颈或者影响启动性能的因素；
(4) 对特定的性能瓶颈或者影响因素设计具体的优化方案，并且实施优化或者实验优化方案；
(4) 针对优化后的应用程序重新回到2来确定具体的优化后的结果，然后和预期的进行比较。

这个过程可以从西面的流程图中得到体现。



测试程序性能启动的方法：
1. 保持相同的测试环境。
2. 测试电脑的OS要尽量的保持“清洁”。不要有过多的其它程序，尤其是会定期活动或者引起网络链接的程序(如防火墙)。
3. 需要每次启动OS，并且在启动后等待一段时间。知道OS的CPU占用、网络占用和IO活动都为0，内存专用量恒定，然后开始测试执行。
4. 测试所用的不同版本的应用程序安装包应该由相同的来源。
5. 测试电脑的电源管理功能，例如由的CPU有自动调整运行频率的功能。为此需要在测试时强制设置为固定频率运行。显卡也要注意类似的问题。


###### 尽量利用自动测试
自动测试更重要的能保证测试结果的精确性及稳定性


#### 优化可行文件及库文件
##### 减少动态链接库的数量
根据实践经验，如果一个应用程序启动时需要加载的动态链接库的达到数十个，则把这些动态库的数量减少到10个以内，至少可以提高启动性能达15%。
(1) 修改代码。减少不必要的动态链接库依赖尽量减少。对针对一些虽然加载，但是代码量很少的动态链接库，把启动需要的函数代码分离出来，加入到其它动态链接库中。确定，可能修改的代码量时巨大的。
(2) 合并动态链接库。把启动时需要加载的多个较小的动态链接库合并成也给大的动态库。

(3) 减小动态链接库的尺寸。清楚冗余的代码

(4) 优化可执行文件和库文件中的代码布局。优化代码布局就是通过重新把动态链接库中的函数排列得更加紧密从而达到减少IO，提高性能的目的。windows上，优化代码布局的总固体步骤分两步：第一，获取函数调用的顺序文件(.PRF，以动态链接库为单位)；第二，把这些PRF文件传递给链接器，链接器自动按照PRF文件把函数在动态链接库中的位置重新排列


#### 优化源代码
(1) 优化启动时读取的配置文件及帮助文件
(2) 预读频繁访问的文件。第一，构造相应的数据结构，把文件读入内存并且解析后将其内容放到也给内存数据结构中，以供后续读取。第二，利用操作系统的文件缓存特性，因为当前大部分硬盘自身带有一定量大小的硬件缓存。程序启动时候，直接读取一篇待缓存的文件，但并不放到具体的数据结构中。由于OS会缓该文件到内存中，从而也可以达到同样的效果并且代码量较小。在欲读时，尽量使用内存映射函数，诸如Windows的MapViewOfFile,Linux的mmap。

(3) 预加载模块
(4) 延迟加载
(5) 多线程优化启动













